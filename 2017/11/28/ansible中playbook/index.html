<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ansible之playbook, Joah">
    <meta name="description" content="一、Playbook1、Playbook核心元素
Hosts：运行指定任务的目标主机
remote_user：在远程主机上执行任务的用户
sudo_user：切换用户


Tasks：任务列表

格式：
  （1）action：module">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ansible之playbook | Joah</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.jpg" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">Joah</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Joah</div>
        <div class="logo-desc">
            
            嘿，终于等到你来了。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/ergedan/" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>fork me
            </a>
        </li>
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/ergedan/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:473823554@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=473823554" class="tooltipped" data-tooltip="QQ联系我: 473823554" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
</div>

            </div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/ergedan/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="fork me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        ansible之playbook
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ansible/" target="_blank">
                                <span class="chip bg-color">ansible</span>
                            </a>
                        
                            <a href="/tags/playbook/" target="_blank">
                                <span class="chip bg-color">playbook</span>
                            </a>
                        
                            <a href="/tags/自动化/" target="_blank">
                                <span class="chip bg-color">自动化</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/自动化/" class="post-category" target="_blank">
                                自动化
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2017-11-28
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        2,862
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        15 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="一、Playbook"><a href="#一、Playbook" class="headerlink" title="一、Playbook"></a>一、Playbook</h2><h3 id="1、Playbook核心元素"><a href="#1、Playbook核心元素" class="headerlink" title="1、Playbook核心元素"></a>1、Playbook核心元素</h3><ul>
<li>Hosts：运行指定任务的目标主机</li>
<li>remote_user：在远程主机上执行任务的用户<ul>
<li>sudo_user：切换用户</li>
</ul>
</li>
<li><p>Tasks：任务列表</p>
<ul>
<li><p>格式：</p>
<p>  （1）action：module argument<br>  （2）module：arguments</p>
</li>
</ul>
</li>
</ul>
<p><strong>注意：shell和command模块后面直接跟命令，而不是key:value的参数列表</strong>    </p>
<ul>
<li><p>Variables：变量</p>
<p>  （1）facts：可直接调用的变量</p>
<pre><code>      可以使用ansible HOSTS -m setup查看
</code></pre><p>  （2）用户自定义的变量</p>
<pre><code>      （a）在命令行中指定使用 -e ARGS或--extra-vars=VARS
      （b）在playbook中定义变量的方法
      vars：
      - var1：values1
      - var2：values2
      ...
</code></pre><p>  （3）通过roles传递变量<br>  （4）Host Inventory</p>
<pre><code>      （a）用户自定义变量
             向不同主机传递不同的变量：
          IP/HOSTNAME  variable=value var1=vaule1
             向组中的主机传递相同的变量可以定义成一个组,可以引用多次
          [groupname:vars]
          variable=value
      （b）invertory参数
          用于定义ansible远程连接目标主机时使用的参数，而非传递给playbook的变量

          ansible_ssh_host
          ansible_ssh_port
          ansible_ssh_user
          ansible_ssh_pass
          ansbile_sudo_pass                  
</code></pre></li>
</ul>
<p>变量引用方法：</p>
<ul>
<li>Template：模板文件</li>
</ul>
<p><strong>注意文件名必须以“j2”结尾。</strong></p>
<p>格式说明：</p>
<pre><code>字符串：使用单引号或双引号
数字：整数、浮点数
列表：[item1,item2..]
元组：（item1，item2...）
字典：{key1:values1,key2:value2...}
布尔型：true/false

算数运算：+ - / *% **
逻辑运算：and or not
</code></pre><ul>
<li>Handers：由特定触发的任务</li>
</ul>
<p>当某个文件参数修改时，这样我们修改了但是并不会立即生效；有没有一个办法当我们修改以后如果某个参数只修改这个文件呢？</p>
<h4 id="notify和tags就是帮我们解决这个问题的。"><a href="#notify和tags就是帮我们解决这个问题的。" class="headerlink" title="notify和tags就是帮我们解决这个问题的。"></a>notify和tags就是帮我们解决这个问题的。</h4><p>notify通知给相应的handler被触发；tags指定某个服务重启。</p>
<h3 id="条件测试"><a href="#条件测试" class="headerlink" title="条件测试"></a>条件测试</h3><p>有时我们管理的主机会使不同版本的服务器，每类型服务的执行的命令有些不同，这时就需要条件判断执行。</p>
<p>when语句：在task中使用，jinja2的语法格式</p>
<pre><code>- hosts: websrvs
  remote_user: root
  tasks:
  - name: install conf file to centos7
    template: src=/root/nginx.conf.j2 dest=/etc/nginx/nginx.conf
    when: ansible_distribution_major_version == &quot;7&quot;
  - name: install conf file to centos6
    template: src=/root/nginx.conf2.j2 dest=/etc/nginx/nginx.conf
    when: ansible_distribution_majoe_version == &quot;6&quot;
</code></pre><h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>迭代，需要重复执行的任务</p>
<p>对迭代项的引用，固定变量名为“item”，要在task中使用with_items给定要迭代的元素列表</p>
<ul>
<li><p>方式一：</p>
<ul>
<li>name: install some package<br>yum: name= state=present<br>with_items：<ul>
<li>nginx</li>
<li>memcache</li>
<li>php-fpm</li>
</ul>
</li>
</ul>
</li>
<li><p>方式二：</p>
<ul>
<li>name: add some users<br>user: name= group=  state=present<br>with_items:<ul>
<li>{ name: ‘user1’,group: ‘group1’ }</li>
<li>{ name: ‘user2’,group: ‘group2’ }</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在playbook调用角色方法一：</p>
<pre><code>- hosts: websrvs
  remote_user: root
  roles:
  - mysql
  - memcached
  - nginx
</code></pre><p>在playbook调用角色方法二：</p>
<ul>
<li>hosts: websrs<br>remote_user: root<br>roles:<ul>
<li>{ role:nginx, username: nignx }</li>
</ul>
</li>
</ul>
<p>键role用于指定角色名称，后续的k/v用于传递变量给角色</p>
<h2 id="二、完整示例"><a href="#二、完整示例" class="headerlink" title="二、完整示例"></a>二、完整示例</h2><blockquote>
<p>安装httpd并配置</p>
</blockquote>
<p>（1）方式一：</p>
<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><p><code>[root@localhost/etc/ansible/roles]#mkdir -pv http/{tasks,templates,files,handlers,vars,meta,default}</code></p>
<h3 id="创建task文件"><a href="#创建task文件" class="headerlink" title="创建task文件"></a>创建task文件</h3><p><code>[root@localhost/etc/ansible/roles/http]#vim tasks/main.yml</code></p>
<pre><code>  1 - name: install package httpd
  2   yum: name=nginx state=latest
  3 - name: create webdoc
  4   file: path={{ http_doc_root }} state=directory
  5 - name: service httpd service
  6   service: name=nginx state=started
  7 - name: configure httpd conf
  8   template: src=httpd.conf.j2 dest=/etc/httpd/conf.d/
  9   tags: httpconf 
 10   notify: reload httpd
</code></pre><h3 id="创建handler文件"><a href="#创建handler文件" class="headerlink" title="创建handler文件"></a>创建handler文件</h3><p><code>[root@localhost/etc/ansible/roles/http]#vim handlers/main.yml</code></p>
<pre><code>  1 - name: relad httpd
  2   service: name=httpd state=reloaded
</code></pre><h3 id="创建vars文件"><a href="#创建vars文件" class="headerlink" title="创建vars文件"></a>创建vars文件</h3><p><code>[root@localhost/etc/ansible/roles/http]#vim vars/main.yml</code></p>
<pre><code>  1 http_server_port: 8080
  2 http_server_name: www.test.com
  3 http_doc_root: /webdate
</code></pre><h3 id="创建template文件"><a href="#创建template文件" class="headerlink" title="创建template文件"></a>创建template文件</h3><p><code>[root@localhost/etc/ansible/roles/http]#vim templates/httpd.conf.j2</code></p>
<pre><code>  1 listen {{ http_server_port }}
  2 ServerName {{ http_server_name }}
  3 DocumentRoot {{ http_doc_root }}
  4 &lt;Directory {{ http_doc_root }}&gt; 
  5     Require all granted
  6 &lt;/Directory&gt;
</code></pre><h3 id="创建剧本"><a href="#创建剧本" class="headerlink" title="创建剧本"></a>创建剧本</h3><p><code>[root@localhost/etc/ansible]#vim http.yml</code></p>
<pre><code>  1 - hosts: websrvs
  2   remote_user: root
  3   roles:
  4   - http
</code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><code>[root@localhost~]#ansible-playbook   /etc/ansible/http.yml</code></p>
<p>实战：基于msm的tomcat集群<br>-</p>
<h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>安装的包</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>192.168.4.61</td>
<td>nginx、keepalived</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.4.62</td>
<td>nginx、keepalived</td>
</tr>
<tr>
<td>node3</td>
<td>192.168.4.63</td>
<td>tomcat、tomcat-docs-webapp、tomcat-webapps、tomcat-adim-webapps、java-1.8.0-openjdk、memcached-session-manager-2.1.1.jar  、memcached-session-manager-tc7-2.1.1.jar、spymemcached-2.12.3.jar  、msm-javolution-serializer-2.1.1.jar 、javolution-5.4.3.1</td>
</tr>
<tr>
<td>node4</td>
<td>192.168.4.64</td>
<td>tomcat、tomcat-docs-webapp、tomcat-webapps、tomcat-adim-webapps、java-1.8.0-openjdk、memcached-session-manager-2.1.1.jar  、memcached-session-manager-tc7-2.1.1.jar、spymemcached-2.12.3.jar  、msm-javolution-serializer-2.1.1.jar 、javolution-5.4.3.1</td>
</tr>
<tr>
<td>node5</td>
<td>192.168.4.65</td>
<td>ansible、memcached</td>
</tr>
</tbody>
</table>
<h3 id="基于ssh密钥认证"><a href="#基于ssh密钥认证" class="headerlink" title="基于ssh密钥认证"></a>基于ssh密钥认证</h3><p><code>[root@node5~]#vim ssh.sh</code></p>
<pre><code>  1 #!/bin/bash
  2 [ ! -f /root/.ssh/id_rsa.pub ] &amp;&amp; ssh-keygen -t rsa -P &#39;&#39; &amp;&gt; /dev/null
  3 while read line;do
  4 expect &lt;&lt; EOF
  5     spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$line
  6     expect {
  7         &quot;yes/no&quot; { send &quot;yes\n&quot;;exp_continue }
  8         &quot;password&quot; { send &quot;magedu\n&quot; }
  9     }
 10     expect eof
 11 EOF
 12 
 13 done &lt; /root/ip.txt
</code></pre><p><code>[root@node5~]#vim ip.txt</code></p>
<pre><code>  1 192.168.4.61
  2 192.168.4.62
  3 192.168.4.63
  4 192.168.4.64
  5 192.168.4.65
</code></pre><p><code>[root@node5~]#chmod +x ssh.sh</code></p>
<h3 id="ansible中修改主机库文件"><a href="#ansible中修改主机库文件" class="headerlink" title="ansible中修改主机库文件"></a>ansible中修改主机库文件</h3><p><code>[root@node5~]#vim /etc/ansible/hosts</code></p>
<pre><code> 25 [nginx-keep]
 26 192.168.4.61
 27 192.168.4.62
 28 [tomcat-cluster]
 29 192.168.4.63
 30 192.168.4.64
 31 [memcached]
 32 192.168.4.65
</code></pre><h3 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h3><p><code>[root@node5/etc/ansible]#vim ntp.yml</code></p>
<pre><code>  1 - hosts: all
  2   remote_user: root
  3   tasks:
  4   - name: sync time
  5     command: ntpdate 172.18.0.1
  6   - name: chrony conf
  7     file: src=/etc/chrony.conf dest=/etc/chrony.conf
  8     tags: chrony
  9     notify: restart chronyd.service
 10   - name: start chrony
 11     service: name=chronyd state=started
 12   handlers:
 13   - name: restart chronyd.service
 14     service: name=chronyd state=restarted
</code></pre><p><code>[root@node5~]#vim /etc/chrony.conf</code></p>
<pre><code>  7 server 172.18.0.1 iburst
</code></pre><p><code>[root@node5/etc/ansible]#ansible-playbook --syntax-check ntp.yml</code> #检测语法是否正确</p>
<h2 id="注意：由于yaml格式对于初学者来说有一定的坑，需要严格按照格式写。"><a href="#注意：由于yaml格式对于初学者来说有一定的坑，需要严格按照格式写。" class="headerlink" title="注意：由于yaml格式对于初学者来说有一定的坑，需要严格按照格式写。"></a>注意：由于yaml格式对于初学者来说有一定的坑，需要严格按照格式写。</h2><p><code>[root@node5/etc/ansible]#ansible-playbook ntp.yml</code> #语法检测没有问题后，执行剧本</p>
<p><img src="http://owatlfstl.bkt.clouddn.com/2017-11-19_184804.jpg" alt=""></p>
<h5 id="温馨提示：为了以后不必要的错误，建议没此执行完以后，都要确认是否执行正确后再进行下一步"><a href="#温馨提示：为了以后不必要的错误，建议没此执行完以后，都要确认是否执行正确后再进行下一步" class="headerlink" title="温馨提示：为了以后不必要的错误，建议没此执行完以后，都要确认是否执行正确后再进行下一步"></a>温馨提示：为了以后不必要的错误，建议没此执行完以后，都要确认是否执行正确后再进行下一步</h5><h3 id="基于主机名解析"><a href="#基于主机名解析" class="headerlink" title="基于主机名解析"></a>基于主机名解析</h3><p><code>[root@node5/etc/ansible]#ansible all  -m copy -a &quot;src=/etc/hosts dest=/etc/hosts&quot;</code></p>
<h3 id="挂载光盘"><a href="#挂载光盘" class="headerlink" title="挂载光盘"></a>挂载光盘</h3><p><code>[root@node5~]#ansible all -m mount -a &quot;name=/media/cdrom src=/dev/sr0 state=mounted fstype=iso9660&quot;</code></p>
<h3 id="配置nginx角色"><a href="#配置nginx角色" class="headerlink" title="配置nginx角色"></a>配置nginx角色</h3><blockquote>
<p>创建所需要的目录</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles]#mkdir haproxy/{tasks,handler,files,templates,vars,default,meta} -pv</code></p>
<blockquote>
<p>创建任务文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/haproxy]#vim tasks/main.yml</code> </p>
<pre><code>  1 - name: install haproxy package
  2   yum: name=haproxy state=latest
  3 - name: modify haproxy conf
  4   template: src=haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg
  5   tags: haproxy
  6   notify: haproxy restart
  7 - name: start haproxy service
  8   service: name=haproxy state=started
  9 handlers:
 10 - name: haproxy restart 
 11   service: name=haproxy state=restarted
</code></pre><blockquote>
<p>创建模板文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/haproxy]#cp /etc/haproxy/haproxy.cfg templates/haproxy.cfg.j2</code></p>
<pre><code> 42 defaults
 43     mode                    http
 44     log                     global
 45     option                  httplog
 46     option                  dontlognull
 47     option http-server-close
 48     option forwardfor       except 127.0.0.0/8
 43     mode                    http
 44     log                     global
 45     option                  httplog
 46     option                  dontlognull
 47     option http-server-close
 48     option forwardfor       except 127.0.0.0/8
 49     option                  redispatch
 50     retries                 3
 51     timeout http-request    10s
 52     timeout queue           1m
 53     timeout connect         10s
 54     timeout client          1m
 55     timeout server          1m
 56     timeout http-keep-alive 10s
 57     timeout check           10s
 58     maxconn                 3000
 59 
 60 frontend tomcat  #定义前段并指定名称
 61    bind 172.18.4.60:{{ tomcat_server_port }}    #绑定地址和端口
 62 
 63 backend tomcat-cluster  #定义后端服务
 64    balance roundrobin
 65    server node3 192.168.4.63 check
 66    server node4 192.168.4.64 check
 67 listen      #定义管理界面
 68    bind 127.0.0.1:9000
 69    stats enable
 70    stats uri /stats
 71    stats auth joah:centos
 72    stats relam &quot;tomcat&quot;
 73    stats hide-version
 74    stats refresh 10s
 75    stats admin if TRUE
</code></pre><p><strong>注意：模板文件必须以“j2”结尾。</strong>  </p>
<blockquote>
<p>创建变量文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/haproxy]#vim vars/main.yml</code></p>
<pre><code>  1 tomcat_server_port: 80
</code></pre><blockquote>
<p>创建触发文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/haproxy]#vim handlers/main.yml</code></p>
<pre><code>  1 - name: haproxy restart
  2   service: name=haproxy state=restarted
</code></pre><p><strong>注意：创建tasks、templates、vars文件时必须以main.yml文件为入口，如果定义别的文件使用include指定即可。</strong></p>
<h3 id="添加IP"><a href="#添加IP" class="headerlink" title="添加IP"></a>添加IP</h3><p><code>[root@node5/etc/ansible/roles/haproxy]#ansible tomcat-cluster -m shell -a  &quot;ip addr add 192.168.4.60/24 dev eth0 &quot;</code></p>
<h3 id="创建keepalived角色"><a href="#创建keepalived角色" class="headerlink" title="创建keepalived角色"></a>创建keepalived角色</h3><blockquote>
<p>创建所需目录</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles]#mkdir keepalived/{tasks,handler,files,templates,vars,default,meta} -pv</code></p>
<blockquote>
<p>创建任务文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/keepalived]#vim tasks/main.yml</code></p>
<pre><code>  1 - name: install keepalived package
  2   yum: name=keepalived state=latest
  3 - name: modify keepalived conf
  4   template: src=keepalived.conf.j2 dest=/etc/keepalived/keepalived.conf
  5   when: ansible_hostname == &quot;node1&quot;
  6   notify: keepalived reloaded
  7   tags: keepalived
  8 - name: modify keepalived conf
  9   template: src=keepalived.conf.j2 dest=/etc/keepalived/keepalived.conf
 10   when: ansible_hostname == &quot;node2&quot;
 11   notify: keepalived reloaded
 12   tags: keepalived
 13 - name: start keepalived
 14   service: name=keepalived state=started
</code></pre><blockquote>
<p>创建触发文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/keepalived]#vim handlers/main.yml</code></p>
<pre><code>  1 - name: keepalived reloaded
  2   service: name=keepalived state=reloaded
</code></pre><blockquote>
<p>创建模板文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/keepalived]#vim templates/keepalived.conf.j2</code>   #创建master</p>
<pre><code>  1 ! Configuration File for keepalived
  2 
  3 global_defs {
  4    notification_email {
  5      locahost@qq.com
  6    }
  7    notification_email_from haproxy@qq.com
  8    smtp_server 127.0.0.1
  9    smtp_connect_timeout 30
 10    router_id node3
 11    route_mcast_group4 224.0.100.4
 12    vrrp_strict chk_haproxy {
 13         script &quot;killall -0 haporxy&quot;
 14         interval 3
 15         weight -15
 16    }
 17 }  
 18 
 19 vrrp_instance VI_1 {
 20     state MASTER
 21     interface eth0
 22     virtual_router_id 4
 23     priority 100
 24     advert_int 1
 25     authentication {
 26         auth_type PASS
 27         auth_pass 152369
 28     }   
 29     virtual_ipaddress {
                172.18.4.60/16
 32     }
 33     track_script {
 34         chk_haproxy
 35     }
 36 }
</code></pre><p><code>[root@node5/etc/ansible/roles/keepalived]#cp templates/keepalived.conf.j2 templates/keepalived.conf2.j2</code> 创建backup</p>
<pre><code>  1 ! Configuration File for keepalived
  2 
  3 global_defs {
  4    notification_email {
  5      locahost@qq.com
  6    }
  7    notification_email_from haproxy@qq.com
  8    smtp_server 127.0.0.1
  9    smtp_connect_timeout 30
 10    router_id node2
 11    route_mcast_group4 224.0.100.4
 12    vrrp_strict chk_haproxy {
 13         script &quot;killall -0 haporxy&quot;
 14         interval 3
 15         weight -15
 16    }
 17 }
 18 
 19 vrrp_instance VI_1 {
 20     state BACKUP
 21     interface eth0
 22     virtual_router_id 4
 23     priority 90
 24     advert_int 1
 25     authentication {
 26         auth_type PASS
 27         auth_pass 152369
 28     }
 29     virtual_ipaddress {
              172.18.4.60/16
 32     }
 33     track_script {
 34         chk_haproxy
 35     }
 36 }
</code></pre><p><strong>注意：</strong></p>
<p><strong>（1）master和backup中<code>priority</code>、<code>state</code>需要修改，其他的配置不需要修改。</strong></p>
<p><strong>（2）如果使用<code>auth_type</code>认证，需要双方<code>auth_pass</code>必须相同</strong></p>
<p><strong>（3）如果你想使用脚本检测，<code>vrrp_script</code>可以指定脚本位置/PATH/TO/SCRIPT.sh</strong></p>
<h3 id="创建tomcat角色"><a href="#创建tomcat角色" class="headerlink" title="创建tomcat角色"></a>创建tomcat角色</h3><blockquote>
<p>创建所需要的目录</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles]#mkdir tomcat/{tasks,handlers,files,templates,vars,default,meta} -pv</code></p>
<blockquote>
<p>创建tomcat任务</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/tomcat]#vim tasks/main.yml</code></p>
<pre><code> 1 - name: install tomcat package
  2   yum: name={{ item }} state=latest
  3   with_items:
  4   - java-1.8.0-openjdk
  5   - tomcat
  6   - tomcat-docs-webapp
  7   - tomcat-admin-webapps
  8   - tomcat-webapps
  9   - memcached
 10 - name: modify tomcat conf
 11   template: src=server.xml.j2 dest=/etc/tomcat/server.xml
 12   notify: tomcat reload
 13   tags: tomcat
 14 - name: kryo jar
 15   copy: src=/root/{{ item }}.jar dest=/usr/share/tomcat/lib/
 16   with_items:
 17   - asm-6.0
 18   - kryo-4.0.1
 19   - kryo-serializers-0.42
 20   - memcached-session-manager-2.1.1
 21   - memcached-session-manager-tc7-2.1.1
 22   - minlog-1.3.0
 23   - msm-kryo-serializer-2.1.1
 24   - objenesis-2.6
 25   - reflectasm-1.11.3
 26   - spymemcached-2.12.3
 27 - name: start tomcat
 28   service: name=tomcat state=started
 29 - name: mkdir directory
 30   file: path=/usr/share/tomcat/webapps/test state=directory
 31 - name: touch file
 32   file: path=/usr/share/tomcat/webapps/test/{{ item }} state=touch
 33   with_items:
 34   - WEB-INF
 35   - classes
 36   - lib 
 37 - name: copy index.jsp
 38   copy: src=index.jsp.j2 dest=/usr/share/tomcat/webapps/index.jsp
 39   when: ansible_hostname == &quot;node3&quot;
 40   notify: tomcat reload
 41   tags: tomcat
 42 - name: copy index.jsp
 43   copy: src=index2.jsp.j2 dest=/usr/share/tomcat/webapps/index.jsp
 44   when: ansible_hostname == &quot;node4&quot;
 45   notify: tomcat reload
 46   tags: tomcat
</code></pre><blockquote>
<p>创建模板文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/tomcat/templates]#vim server.xml.j2</code></p>
<pre><code>126       &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
127             unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
128         &lt;Context path=&quot;&quot; docBase=&quot;test&quot; reloadable=&quot;&quot; /&gt;
129 &lt;Context&gt;
130   &lt;Manager className=&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;
131     memcachedNodes=&quot;n1:192.168.4.63:11211,n2:192.168.4.64:11211&quot;    #指定位置
132     failoverNodes=&quot;n1&quot;
133     requestUriIgnorePattern=&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;
134     transcoderFactoryClass=&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;
135     /&gt;
136 &lt;/Context&gt;
</code></pre><p><code>[root@node5/etc/ansible/roles/tomcat/templates]#vim index.jsp.j2</code></p>
<pre><code>  1 &lt;%@ page language=&quot;java&quot; %&gt;
  2 &lt;html&gt;
  3         &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;
  4         &lt;body&gt;
  5                 &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;TomcatA.test.com&lt;/font&gt;&lt;/h1&gt;
  6                 &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;
  7                         &lt;tr&gt;
  8                                 &lt;td&gt;Session ID&lt;/td&gt;
  9                         &lt;% session.setAttribute(&quot;test.com&quot;,&quot;test.com&quot;); %&gt;
 10                                 &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;
 11                         &lt;/tr&gt;
 12                         &lt;tr&gt;
 13                                 &lt;td&gt;Created on&lt;/td&gt;
 14                                 &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;
 15                         &lt;/tr&gt;
 16                 &lt;/table&gt;
 17         &lt;/body&gt;
 18 &lt;/html&gt;
</code></pre><p><code>[root@node5/etc/ansible/roles/tomcat/templates]#vim index2.jsp.j2</code></p>
<pre><code>  1 &lt;%@ page language=&quot;java&quot; %&gt;
  2 &lt;html&gt;
  3         &lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;
  4                 &lt;body&gt;
  5                 &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;TomcatB.test.com&lt;/font&gt;&lt;/h1&gt;
  6                 &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;
  7                         &lt;tr&gt;
  8                                 &lt;td&gt;Session ID&lt;/td&gt;
  9                         &lt;% session.setAttribute(&quot;test.com&quot;,&quot;test.com&quot;); %&gt;
 10                                 &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;
 11                         &lt;/tr&gt;
 12                         &lt;tr&gt;
 13                                 &lt;td&gt;Created on&lt;/td&gt;
 14                                 &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;
 15                         &lt;/tr&gt;
 16                 &lt;/table&gt;
 17                 &lt;/body&gt;
 18 &lt;/html&gt;
</code></pre><blockquote>
<p>编辑触发文件</p>
</blockquote>
<p><code>[root@node5/etc/ansible/roles/tomcat]#vim handlers/main.yml</code></p>
<pre><code>  1 - name: tomcat reload
  2   service: name=tomcat state=reloaded
</code></pre><blockquote>
<p>编辑剧本</p>
</blockquote>
<p><code>[root@node5/etc/ansible]#vim tomcat.yml</code></p>
<pre><code>  1 - hosts: nginx-keep
  2   remote_user: root
  3   roles:
  4   - keepalived
  5   - haproxy
  6 - hosts: tomcat-cluster
  7   remote_user: root
  8   roles:
  9   - tomcat
</code></pre>
            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="www.lmfe.org" class="b-link-green">Joah</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2017/11/28/ansible中playbook/" class="b-link-green">ansible之playbook</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2017/11/28/axel/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="axel">
                        
                        <span class="card-title">axel</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">axelaxel是 Linux 下一个不错的HTTP/FTP高速下载工具。支持多线程下载、断点续传，且可以从多个地址或者从一个地址的多个连接来下载同一个文件。适合网速不给力时多线程下载提高下载速度
--max-speed=x        </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2017-11-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/命令/" class="post-category" target="_blank">
                                    命令
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/axel/" target="_blank">
                        <span class="chip bg-color">axel</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2017/11/28/dig、nslookup等工具/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="dig和nslookup命令">
                        
                        <span class="card-title">dig和nslookup命令</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">管理命令1、dig命令作用：只能用于测试DNS系统，不会查询hosts文件进行解析。
格式：
dig [@server] [-b address] [-c class] [-f filename] [-k filename] [-m]
  </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2017-11-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/命令/" class="post-category" target="_blank">
                                    命令
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/dig，nslookup/" target="_blank">
                        <span class="chip bg-color">dig，nslookup</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">181.1k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/ergedan/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:473823554@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=473823554" class="tooltipped" data-tooltip="QQ联系我: 473823554" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>